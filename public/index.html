<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hyperliquid BTC Perp Tracker</title>
    <meta name="theme-color" content="#0f1218" />
    <link rel="preload" href="/styles.css" as="style" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="site-header">
        <h1>Hyperliquid BTC Perp Tracker</h1>
        <div class="small muted">Live BTC perp address monitoring</div>
      </header>

      <div class="card" aria-labelledby="addressEntryTitle">
        <div class="row" style="align-items:flex-start;">
          <div style="display:flex; flex-direction:column; gap:6px;">
            <label class="small muted" id="addressEntryTitle" for="addrInput">Add a Hyperliquid address</label>
            <div class="row">
              <input id="addrInput" type="text" placeholder="0x..." autocomplete="off" inputmode="text" aria-label="Hyperliquid address" />
              <button id="addBtn" aria-label="Add address to tracking list">Add address</button>
            </div>
            <span id="addMsg" class="muted small" role="status" aria-live="polite"></span>
          </div>
        </div>
      </div>

      <div class="card" aria-labelledby="trackedAddressesTitle">
        <div class="flex space-between mb-2" style="align-items:center; gap:8px;">
          <h3 id="trackedAddressesTitle" style="margin:0">Tracked addresses</h3>
          <button id="pollNowBtn" title="Trigger an immediate server poll" aria-label="Manually refresh now">Refresh now</button>
        </div>
        <table>
          <thead>
            <tr><th>Address</th><th style="width:120px;">Actions</th></tr>
          </thead>
          <tbody id="addrTbody"></tbody>
        </table>
      </div>

      <div class="card" aria-labelledby="recommendationsTitle">
        <h3 id="recommendationsTitle" style="margin:0 0 8px">Recommendations</h3>
        <div id="recs" aria-live="polite"></div>
        <div class="muted small" id="lastUpdated"></div>
      </div>
    </div>

    <script>
      const addrInput = document.getElementById('addrInput');
      const addBtn = document.getElementById('addBtn');
      const addMsg = document.getElementById('addMsg');
      const addrTbody = document.getElementById('addrTbody');
      const recsDiv = document.getElementById('recs');
      const lastUpdated = document.getElementById('lastUpdated');
      const pollNowBtn = document.getElementById('pollNowBtn');

      async function fetchAddresses() {
        const r = await fetch('/api/addresses');
        return (await r.json()).addresses || [];
      }

      async function fetchRecs() {
        const r = await fetch('/api/recommendations');
        return (await r.json()).recommendations || [];
      }

      function renderAddresses(addresses) {
        addrTbody.innerHTML = '';
        addresses.forEach(a => {
          const tr = document.createElement('tr');
          const tdA = document.createElement('td');
          const link = document.createElement('a');
          link.href = '#';
          link.textContent = a;
          link.addEventListener('click', (e) => { e.preventDefault(); showHoldings(a); });
          tdA.appendChild(link);

          const tdActions = document.createElement('td');
          const rm = document.createElement('button');
          rm.textContent = 'Remove';
          rm.addEventListener('click', async () => {
            await removeAddress(a);
            await refresh();
          });
          tdActions.appendChild(rm);

          tr.appendChild(tdA);
          tr.appendChild(tdActions);
          addrTbody.appendChild(tr);
        });
      }

      function renderRecs(recs) {
        recsDiv.innerHTML = '';
        recs.forEach(r => {
          const row = document.createElement('div');
          row.style.marginBottom = '10px';
          const scoreClass = r.score > 0 ? 'positive' : (r.score < 0 ? 'negative' : '');
          row.innerHTML = `
            <div class="small muted">${r.timestamp}</div>
            <div><span class="score ${scoreClass}">Score: ${r.score.toFixed(2)}</span> — ${r.text}</div>
            <div class="small muted">Address: ${r.address} • Exposure: ${r.exposureBtc.toFixed(4)} BTC • Price: $${r.priceUsd.toFixed(0)}</div>
          `;
          recsDiv.appendChild(row);
        });
        lastUpdated.textContent = recs.length ? `Last updated: ${new Date().toLocaleTimeString()}` : '';
      }

      async function refresh() {
        try {
          const [addrs, recs] = await Promise.all([fetchAddresses(), fetchRecs()]);
          renderAddresses(addrs);
          renderRecs(recs);
        } catch (e) {
          console.error('refresh failed', e);
        }
      }

      addBtn.addEventListener('click', async () => {
        const address = (addrInput.value || '').trim();
        addMsg.textContent = '';
        if (!address) return;
        try {
          const r = await fetch('/api/addresses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address })
          });
          if (!r.ok) {
            const j = await r.json().catch(() => ({}));
            addMsg.textContent = j.error || 'Failed to add address';
            return;
          }
          addrInput.value = '';
          addMsg.textContent = 'Added';
          setTimeout(() => (addMsg.textContent = ''), 1200);
          await refresh();
        } catch (e) {
          addMsg.textContent = 'Network error';
        }
      });

      pollNowBtn.addEventListener('click', async () => {
        pollNowBtn.disabled = true;
        try {
          await fetch('/api/poll-now', { method: 'POST' });
          await refresh();
        } finally {
          pollNowBtn.disabled = false;
        }
      });

      async function removeAddress(address) {
        await fetch(`/api/addresses/${encodeURIComponent(address)}`, { method: 'DELETE' });
      }

      // Modal for holdings
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  const modalCard = document.createElement('div');
  modalCard.className = 'modal-card';
  modalCard.innerHTML = '<div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;"><strong>Perp holdings</strong><button id="modalClose" aria-label="Close holdings modal">Close</button></div><div id="modalBody" class="small"></div>';
      modal.appendChild(modalCard);
      document.body.appendChild(modal);
      document.getElementById('modalClose').addEventListener('click', () => { modal.style.display = 'none'; });

      async function showHoldings(address) {
  modal.style.display = 'flex';
        const body = modal.querySelector('#modalBody');
        body.textContent = 'Loading...';
        try {
          const r = await fetch(`/api/positions/${encodeURIComponent(address)}`);
          const j = await r.json();
          const positions = j.positions || [];
          if (!positions.length) {
            body.textContent = 'No open perp positions.';
            return;
          }
          const tbl = document.createElement('table');
          tbl.style.width = '100%';
          tbl.style.borderCollapse = 'collapse';
          tbl.innerHTML = '<thead><tr><th>Symbol</th><th>Side</th><th>Size</th><th>Entry</th><th>Lev</th></tr></thead>';
          const tb = document.createElement('tbody');
          positions.forEach(p => {
            const tr = document.createElement('tr');
            const side = p.size > 0 ? 'Long' : 'Short';
            tr.innerHTML = `
              <td>${p.symbol}</td>
              <td>${side}</td>
              <td>${Math.abs(p.size).toFixed(4)}</td>
              <td>${p.entryPriceUsd ? ('$' + Number(p.entryPriceUsd).toFixed(0)) : '-'}</td>
              <td>${p.leverage ? Number(p.leverage).toFixed(1) + 'x' : '-'}</td>
            `;
            Array.from(tr.children).forEach(td => td.style.padding = '6px');
            tb.appendChild(tr);
          });
          tbl.appendChild(tb);
          body.innerHTML = '';
          body.appendChild(tbl);
        } catch (e) {
          body.textContent = 'Failed to load holdings.';
        }
      }

      // Initial load and polling every 10s
      refresh();
      setInterval(refresh, 10_000);
    </script>
  </body>
  </html>
